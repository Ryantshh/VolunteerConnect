<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Questionnaire</title>
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Vue.js 3.2.37 Script -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.min.js"></script>
    <link rel="stylesheet" href="questionnaire.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="../config.js"></script> <!-- Firebase config file -->

</head>

<body>
    <div id="app">
        <div>
            <!-- Navbar -->
            <nav class="navbar navbar-light bg-light">
                <div class="container d-flex justify-content-between ">
                    <!-- Use mx-auto for centering on smaller screens, and align left on larger screens -->
                    <a>
                        <!-- Animated char -->
                        <div class="container mt-5">
                            <!-- Character and speech bubble aligned horizontally -->
                            <div class="character-container">
                                <!-- Animated GIF of the character -->
                                <img src="duolingo.gif" alt="Animated Character" class="character-img img-fluid">

                                <!-- Speech bubble -->
                                <div class="speech speech-bubble">
                                    <h5>{{questions[currentStep-1]}}</h5>
                                </div>
                            </div>
                        </div>
                    </a>
                    <a class="navbar-brand d-none d-md-block" href="#">
                        <img src="Volunteer.png" alt="Logo" class="img-fluid" style="max-width: 70px;">
                    </a>
                </div>
            </nav>

        </div>

        <!-- Message bar for displaying success or error notifications -->
        <div v-if="showMessageBar"
            style="position: fixed; top: 0; left: 0; width: 100%; background-color: green; color: white; text-align: center; padding: 10px; font-size: 16px; z-index: 1000;">
            {{ submissionMessage }}
        </div>

        <div class="myContainer">
            <!-- Interests Page -->
            <div v-if="currentStep === 1" class="form-page active">

                <div class="scrollable-list">
                    <div v-for="interest in interestsList" :key="interest" class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" v-model="formData.interests" :value="interest"
                            :id="interest">
                        <label class="form-check-label" :for="interest">{{ interest }}</label>
                    </div>
                </div>
                <!-- Progress Bar directly below the form -->
                <div class="progress-container">
                    <div class="progress-bar" :style="{ width: progress + '%' }"></div>
                </div>

                <!-- First page next button on the right -->
                <div style="position: fixed;bottom: 50px; width: 100%; left: 0; ">
                    <hr>
                    <div class="btn-group">
                        <span></span>
                        <button class="btn-custom" @click="nextStep"
                            :disabled="formData.interests.length === 0">Next</button>
                    </div>

                </div>
            </div>

            <!-- Skills Page -->
            <div v-if="currentStep === 2" class="form-page active">
                <div class="scrollable-list">
                    <div v-for="skill in skillsList" :key="skill" class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" v-model="formData.skills" :value="skill"
                            :id="skill">
                        <label class="form-check-label" :for="skill">{{ skill }}</label>
                    </div>
                </div>
                <!-- Progress Bar directly below the form -->
                <div class="progress-container">
                    <div class="progress-bar" :style="{ width: progress + '%' }"></div>
                </div>
                <!-- Back on the left, next on the right -->
                <div style="position: fixed;bottom: 50px; width:100%; left: 0;">
                    <hr>
                    <div class="btn-group">
                        <button class="btn-custom" @click="prevStep">Back</button>
                        <button class="btn-custom" @click="nextStep"
                            :disabled="formData.skills.length === 0">Next</button>
                    </div>
                </div>
            </div>

            <!-- Availability Page -->
            <div v-if="currentStep === 3" class="form-page active">
                <div class="scrollable-list">
                    <div v-for="day in daysOfWeek" :key="day" class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" v-model="formData.availability" :value="day"
                            :id="day">
                        <label class="form-check-label" :for="day">{{ day }}</label>
                    </div>
                </div>
                <!-- Progress Bar directly below the form -->
                <div class="progress-container">
                    <div class="progress-bar" :style="{ width: progress + '%' }"></div>
                </div>
                <!-- Back on the left, next on the right -->
                <div style="position: fixed;bottom: 50px; width:100%; left: 0;">
                    <hr>
                    <div class="btn-group">
                        <button class="btn-custom" @click="prevStep">Back</button>
                        <button class="btn-custom" @click="nextStep"
                            :disabled="formData.availability.length === 0">Next</button>
                    </div>
                </div>
            </div>

            <!-- Address and Postal Code Page -->
            <div v-if="currentStep === 4" class="form-page active">
                <div class="mb-3">
                    <label for="address" class="form-label">Full Address (optional)</label>
                    <input type="text" v-model="formData.address" class="form-control" placeholder="Enter your address">
                </div>
                <div class="mb-3">
                    <label for="postalCode" class="form-label">Postal Code (required)</label>
                    <input type="text" v-model="formData.postalCode" class="form-control"
                        placeholder="Enter your postal code" required>
                    <p class="error text-danger" v-if="postalCodeError">{{ postalCodeError }}</p>
                </div>
                <!-- Progress Bar directly below the form -->
                <div class="progress-container">
                    <div class="progress-bar" :style="{ width: progress + '%' }"></div>
                </div>
                <!-- Back on the left, submit on the right -->
                <div class="btn-group">
                    <button class="btn-custom" @click="prevStep">Back</button>
                    <button class="btn-custom" @click="submitForm">Submit</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Vue.js App -->
    <script>


        const app = Vue.createApp({
            data() {
                return {
                    submissionMessage: '',
                    showMessageBar: false,
                    currentStep: 1,  // Track the current step number
                    formData: {
                        interests: [],
                        skills: [],
                        availability: [],
                        address: '',
                        postalCode: '',
                    },
                    postalCodeError: '',  // To display error message
                    isPostalCodeValid: false,  // Track if postal code is valid
                    // Interests options
                    interestsList: [
                        'Environmental', 'Community Development', 'Education', 'Healthcare', 'Animal Welfare',
                        'Disaster Relief', 'Youth Services', 'Senior Care', 'Human Rights', 'Sports Coaching',
                        'Poverty Alleviation', 'Homelessness', 'Cultural Heritage', 'Mental Health', 'Advocacy'
                    ],
                    // Skills options
                    skillsList: [
                        'First Aid/CPR', 'Teaching', 'Public Speaking', 'Fundraising', 'Event Planning', 'Communication', 'Leadership', 'Project Management', 'Mentoring/Coaching',
                        'Social Media Management', 'Grant Writing', 'Graphic Design', 'Web Development', 'Data Analysis',
                        'Tutoring', 'Photography/Videography', 'Technical Support', 'Healthcare Assistance', 'Food Preparation', 'Marketing'
                    ],
                    // Days of the week options
                    daysOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                    //form questions
                    questions: ['Now letâ€™s find the best place to start! What are your main interests?', 'Now what are your main skills?', 'What are your available days?', 'To help us match you with the nearest and most suitable volunteering opportunities, please provide your home location.']

                };
            },
            computed: {
                // Calculate the progress percentage
                progress() {
                    return (this.currentStep / 4) * 100;
                }
            },
            methods: {
                nextStep() {
                    if (this.currentStep < 4) {
                        this.currentStep++;
                    }
                },
                prevStep() {
                    if (this.currentStep > 1) {
                        this.currentStep--;
                    }
                },
                validatePostalCode() {
                    const postalCodePattern = /^[0-9]{6}$/;
                    if (!postalCodePattern.test(this.formData.postalCode)) {
                        this.postalCodeError = 'Postal code must be exactly 6 digits.';
                        this.isPostalCodeValid = false;
                    } else {
                        this.postalCodeError = '';
                        this.isPostalCodeValid = true;
                    }
                },
                submitForm() {
                    this.validatePostalCode();
                    if (this.isPostalCodeValid) {
                        // Initialize Firebase
                        firebase.initializeApp(firebaseConfig);

                        // Firestore and Auth reference
                        const db = firebase.firestore();
                        const auth = firebase.auth();

                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                // User is logged in
                                const uid = user.uid;  // Get the authenticated user's UID

                                // Data to upload to Firestore
                                const userData = {
                                    interests: this.formData.interests,
                                    skills: this.formData.skills,
                                    location: this.formData.postalCode,
                                    uid: uid  // Store the authenticated user's UID
                                };

                                // Check if the document for this user exists
                                db.collection('UserQuestionnaire').where('uid', '==', uid).get()
                                    .then((querySnapshot) => {
                                        if (!querySnapshot.empty) {
                                            // If document exists, update the existing document
                                            const docId = querySnapshot.docs[0].id; // Get the document ID of the first match
                                            db.collection('UserQuestionnaire').doc(docId).update(userData)
                                                .then(() => {
                                                    console.log('Document successfully updated!');
                                                    this.submissionMessage = "Form updated successfully!";
                                                    this.showMessageBar = true;  // Show the message bar

                                                    // Hide message bar after 3 seconds and redirect
                                                    setTimeout(() => {
                                                        this.showMessageBar = false;
                                                        window.location.href = 'homepage.html';  // Redirect after success
                                                    }, 3000);
                                                })
                                                .catch((error) => {
                                                    console.error('Error updating document: ', error);
                                                    this.submissionMessage = "Error updating form: " + error.message;
                                                    this.showMessageBar = true;

                                                    // Hide message bar after 3 seconds
                                                    setTimeout(() => {
                                                        this.showMessageBar = false;
                                                    }, 3000);
                                                });
                                        } else {
                                            // If no document exists, create a new one
                                            db.collection('UserQuestionnaire').add(userData)
                                                .then(() => {
                                                    console.log('Document successfully written!');
                                                    this.submissionMessage = "Form submitted successfully!";
                                                    this.showMessageBar = true;  // Show the message bar

                                                    // Hide message bar after 3 seconds and redirect
                                                    setTimeout(() => {
                                                        this.showMessageBar = false;
                                                        window.location.href = 'homepage.html';  // Redirect after success
                                                    }, 3000);
                                                })
                                                .catch((error) => {
                                                    console.error('Error writing document: ', error);
                                                    this.submissionMessage = "Error submitting form: " + error.message;
                                                    this.showMessageBar = true;

                                                    // Hide message bar after 3 seconds
                                                    setTimeout(() => {
                                                        this.showMessageBar = false;
                                                    }, 3000);
                                                });
                                        }
                                    })
                                    .catch((error) => {
                                        console.error('Error checking for existing document: ', error);
                                        this.submissionMessage = "Error checking for existing data: " + error.message;
                                        this.showMessageBar = true;

                                        // Hide message bar after 3 seconds
                                        setTimeout(() => {
                                            this.showMessageBar = false;
                                        }, 3000);
                                    });

                            } else {
                                // User is not logged in
                                alert('You must be logged in to submit the form.');
                                // Optionally, redirect to a login page
                                window.location.href = "/";
                            }
                        });

                    }
                }
            }
        }).mount('#app');
    </script>
</body>


</html>