<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonprofit Listings</title>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./posting.css">
    <!-- Firebase App -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>

    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>
    <script src="../config.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <!-- Navbar Brand -->
            <a class="navbar-brand" href="#">
                <img src="images/Volunteer.png" alt="logo" />
            </a>

            <!-- Toggler for mobile view -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navbar Links-->
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="active" href="#">Explore</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Calendar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Donate</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">For You</a>
                    </li>
                </ul>
            </div>

            <!-- Sign In Button on the far right -->
            <div class="d-flex">
                <button id="signin" class="btn" type="button">My Profile</button>
            </div>
        </div>
    </nav>

    <div id="app">
        <div id="post" class="container fluid">
            <div class="form-container">
                <h2 class="form-title">Create Volunteer Event</h2>

                <!-- Form submission handled by handleSubmit method -->
                <form @submit.prevent="handleSubmit" id="listing-form" class="listing-form">

                    <div class="form-group">
                        <label for="listing-name">Event Name</label>
                        <input v-model="newListing.title" type="text" id="listing-name" class="form-control" required
                            placeholder="Enter listing name">
                    </div>

                    <div class="form-group">
                        <label for="listing-description">Description</label>
                        <textarea v-model="newListing.description" id="listing-description" class="form-control"
                            rows="4" required placeholder="Describe the volunteer opportunity..."></textarea>
                    </div>

                    <div class="date-time-container">
                        <div class="form-group date-group">
                            <label for="event-date">Event Date</label>
                            <input v-model="newListing.date" type="date" id="event-date" class="form-control" required>
                        </div>

                        <div class="form-group time-group">
                            <label for="listing-time">Event Time</label>
                            <div class="time-inputs">
                                <input v-model="newListing.startTime" type="time" id="listing-start-time"
                                    class="form-control" required>
                                <span class="time-separator">to</span>
                                <input v-model="newListing.endTime" type="time" id="listing-end-time"
                                    class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="event-categories">Event Categories</label>
                        <input v-model="newListing.category" type="text" id="event-categories" class="form-control"
                            placeholder="Enter categories separated by commas">
                    </div>

                    <div class="form-group">
                        <label for="event-skills">Skills Required</label>
                        <input v-model="newListing.skills" type="text" id="event-skills" class="form-control"
                            placeholder="Enter skills separated by commas">
                    </div>

                    <div class="form-group">
                        <label for="location-input">Event Location Postal Code</label>
                        <input v-model="newListing.location" type="text" id="location-input" class="form-control"
                            placeholder="Enter Postal Code" required>
                    </div>

                    <div class="form-group">
                        <label for="listing-photo">Upload Photo</label>
                        <div class="file-upload">
                            <!-- File input with Vue's change handler -->
                            <input type="file" id="listing-photo" class="file-input" accept="image/*"
                                @change="handleImageUpload">
                            <label for="listing-photo" class="file-label">
                                <span class="upload-icon">ðŸ“·</span>
                                <span class="upload-text">{{ uploadText }}</span>
                            </label>
                            <!-- Display error message if no image is selected -->
                            <span v-if="noImage" style="color: red;">Please upload a photo!</span>
                            <!-- Image preview area -->
                            <div class="file-preview" v-if="imagePreviewUrl">
                                <img :src="imagePreviewUrl" alt="Image Preview"
                                    style="max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 8px;">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">
                        Post Volunteer Listing
                        <span class="btn-overlay"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="posting.js">

        // Add this JavaScript to create the floating hearts
    </script>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    newListing: {
                        title: '',
                        description: '',
                        date: '',
                        startTime: '',
                        endTime: '',
                        category: '',
                        skills: '',
                        location: '',
                        imageUrl: '' // File input for image upload
                    },
                    imageFile: null,         // Temporarily store the selected image file
                    imagePreviewUrl: '',     // Store the preview URL for the image file
                    uploadText: 'Choose a file', // Text to show on upload button
                    noImage: false           // Tracks if an image was not selected
                };
            },
            methods: {
                // Method to handle file input and display preview
                handleImageUpload(event) {
                    const file = event.target.files[0]; // Get the selected file

                    if (file) {
                        this.noImage = false; // Clear any previous no-image error
                        this.imageFile = file; // Store the file for later upload
                        this.uploadText = file.name; // Display the file name

                        // Generate a preview URL
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.imagePreviewUrl = e.target.result; // Set the preview URL
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // Reset everything if no file is selected
                        this.uploadText = 'Choose a file';
                        this.imagePreviewUrl = '';
                    }
                },

                async handleSubmit(event) {
                    event.preventDefault();

                    // Check if an image file is selected
                    if (!this.imageFile) {
                        this.noImage = true; // Set noImage to true if no image is selected
                        console.warn("No image file selected");
                        return;
                    }

                    try {
                        // Upload the image to Firebase Storage
                        const storageRef = firebase.storage().ref(`images/${this.imageFile.name}`);
                        const snapshot = await storageRef.put(this.imageFile);

                        // Get the download URL of the uploaded image and assign it to imageUrl
                        this.newListing.imageUrl = await snapshot.ref.getDownloadURL();
                        console.log("Listing submitted with image URL:", this.newListing.imageUrl);

                        // Save newListing to Firestore in the "listings" collection
                        await db.collection("listings").add(this.newListing);
                        console.log("Data successfully written to Firestore:", this.newListing);

                        // Clear form data after submission
                        Object.keys(this.newListing).forEach((key) => {
                            if (key !== 'imageUrl') this.newListing[key] = '';
                        });

                        // Reset file-related fields
                        this.imageFile = null;
                        this.imagePreviewUrl = '';
                        this.uploadText = 'Choose a file';
                        this.noImage = false; // Reset the noImage flag after a successful upload
                    } catch (error) {
                        console.error("Error uploading image or writing to Firestore:", error);
                    }
                }
            }
        });

        // Mount the Vue instance to the #app element
        app.mount('#app');

    </script>




</body>

</html>