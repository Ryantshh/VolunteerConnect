<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile</title>
    <link type="text/css" href="css/profile.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <!-- Load Firebase App, Auth, and Firestore scripts from the CDN -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
</head>

<body>
    <div id="app">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img src="images/Volunteer.png" alt="logo" />
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Explore</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Calendar</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Donate</a></li>
                    </ul>
                </div>
                <div class="d-flex">
                    <button id="signin" class="btn" @click="goToProfile">My Profile</button>
                </div>
            </div>
        </nav>

        <!-- User Profile Form -->
        <div v-if="loading">Loading...</div>
        
        <div v-else>
            <h1>User Profile</h1>

            <!-- Name Input -->
            <div class="field">
                <label for="name">Name:</label>
                <input type="text" v-model="userProfile.fullName" class="editInput" />
            </div>

            <!-- Postal Code Input -->
            <div class="field">
                <label for="postalCode">Postal Code:</label>
                <input type="text" v-model="userProfile.postalCode" class="editInput" />
            </div>

            <!-- Interests -->
            <div>
                <h3>Interests</h3>
                <div id="interestsDisplay">
                    <button v-for="interest in userProfile.interests" :key="interest" class="button-container">
                        {{ interest }}
                        <span class="removeButton" @click="removeInterest(interest)">✖</span>
                    </button>
                </div>
                <select v-model="selectedInterest" class="form-select">
                    <option v-for="interest in interestsList" :key="interest" :value="interest">{{ interest }}</option>
                </select>
                <button @click="addInterest">Add Interest</button>
            </div>

            <!-- Skills -->
            <div>
                <h3>Skills</h3>
                <div id="skillsDisplay">
                    <button v-for="skill in userProfile.skills" :key="skill" class="button-container">
                        {{ skill }}
                        <span class="removeButton" @click="removeSkill(skill)">✖</span>
                    </button>
                </div>
                <select v-model="selectedSkill" class="form-select">
                    <option v-for="skill in skillsList" :key="skill" :value="skill">{{ skill }}</option>
                </select>
                <button @click="addSkill">Add Skill</button>
            </div>

            <!-- Available Days -->
            <div>
                <h3>Available Days</h3>
                <div id="availableDaysDisplay">
                    <button v-for="day in userProfile.availability" :key="day" class="button-container">
                        {{ day }}
                        <span class="removeButton" @click="removeAvailableDay(day)">✖</span>
                    </button>
                </div>
                <select v-model="selectedDay" class="form-select">
                    <option v-for="day in daysOfWeek" :key="day" :value="day">{{ day }}</option>
                </select>
                <button @click="addAvailableDay">Add Day</button>
            </div>

            <!-- User Posting -->
            <div v-if="userPosting!=[]">
                <h3>Your Events</h3>
                <br>
                <div class="d-flex d-sm-block justify-content-center">
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                        <div v-for="(listing, index) in userPosting" :key="index" class="col">
                            <div class="card m-2" style="width: 100%;">
                                <img :src="listing.imageUrl" class="card-img-top" alt="Listing image">
                                <div class="card-body">
                                    <h5 class="card-title">{{ listing.title }}</h5>
                                    <p class="card-text">{{ listing.description }}</p>
                                    <p class="card-text"><strong>Location:</strong> {{ listing.location }}</p>
                                    <p class="card-text">
                                        <strong>Skills:</strong>
                                        {{ Array.isArray(listing.skills) ? listing.skills.join(', ') : listing.skills
                                        ||"No skills listed" }}
                                    </p>
                                    <p class="card-text">
                                        <strong>Days Required:</strong>
                                        {{ Array.isArray(listing.daysOfWeek) && listing.daysOfWeek.length ?
                                        listing.daysOfWeek.join(', ') : "No days listed" }}
                                    </p>
                                </div>
                                <div class="card-footer text-center">
                                    <button @click="removeListing(index, listing.id)"
                                        class="btn btn-primary my-2">Delete
                                        Post</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Submit Button -->
            <button @click="submitProfile" style="margin-top: 40px">Submit</button>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3.0.0-rc.11/dist/vue.global.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    userProfile: {
                        fullName: "",
                        postalCode: "",
                        interests: [],
                        skills: [],
                        availability: []
                    },
                    interestsList: [
                        "Environmental", "Community Development", "Education", "Healthcare",
                        "Animal Welfare", "Disaster Relief", "Youth Services", "Senior Care",
                        "Human Rights", "Sports Coaching", "Poverty Alleviation", "Homelessness",
                        "Cultural Heritage", "Mental Health", "Advocacy"
                    ],
                    skillsList: [
                        "First Aid/CPR", "Teaching", "Public Speaking", "Fundraising",
                        "Event Planning", "Communication", "Leadership", "Project Management",
                        "Mentoring/Coaching", "Social Media Management", "Grant Writing", "Graphic Design",
                        "Web Development", "Data Analysis", "Tutoring", "Photography/Videography",
                        "Technical Support", "Healthcare Assistance", "Food Preparation", "Marketing"
                    ],
                    daysOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
                    selectedInterest: null,
                    selectedSkill: null,
                    selectedDay: null,
                    loading: true, // Loading state to manage authentication status
                    userPosting: [], // Stores the listings for the logged-in user
                };
            },
            created() {
                // Use onAuthStateChanged to check if a user is authenticated
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // Only call getUserProfile if the user is authenticated
                        this.getUserProfile(user.uid);
                        // User is authenticated, fetch the listings
                        this.fetchUserPostings(user.uid);
                    } else {
                        console.log("No user is logged in. Redirecting to root...");
                        window.location.href = "/"; // Redirect if not logged in
                    }
                    this.loading = false; // Set loading to false once the authentication state is resolved
                });
            },
            methods: {
                async fetchUserPostings(uid) {
                    try {
                        const querySnapshot = await db
                            .collection("listings")
                            .where("userId", "==", uid)
                            .get();

                        // Map the documents to include document IDs for each listing
                        this.userPosting = querySnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        console.log("User postings loaded:", this.userPosting);
                    } catch (error) {
                        console.error("Error fetching user postings:", error);
                    }
                },
                async removeListing(index, listingId) {
                    try {
                        // Remove the listing from Firestore
                        await db.collection("listings").doc(listingId).delete();
                        // Remove the listing from the local array to update the UI
                        this.userPosting.splice(index, 1);
                        console.log("Listing deleted:", listingId);
                    } catch (error) {
                        console.error("Error deleting listing:", error);
                    }
                },
                async getUserProfile(uid) {
                    try {
                        const querySnapshot = await db.collection("UserQuestionnaire")
                            .where("uid", "==", uid)
                            .limit(1)
                            .get();

                        if (!querySnapshot.empty) {
                            this.userProfile = querySnapshot.docs[0].data();
                            console.log("User profile loaded:", this.userProfile);
                        } else {
                            console.log("No profile found for this user.");
                        }
                    } catch (error) {
                        console.error("Error loading user profile:", error);
                    }
                },
                addInterest() {
                    if (this.selectedInterest && !this.userProfile.interests.includes(this.selectedInterest)) {
                        this.userProfile.interests.push(this.selectedInterest);
                        this.selectedInterest = null;
                    }
                },
                removeInterest(interest) {
                    this.userProfile.interests = this.userProfile.interests.filter(i => i !== interest);
                },
                addSkill() {
                    if (this.selectedSkill && !this.userProfile.skills.includes(this.selectedSkill)) {
                        this.userProfile.skills.push(this.selectedSkill);
                        this.selectedSkill = null;
                    }
                },
                removeSkill(skill) {
                    this.userProfile.skills = this.userProfile.skills.filter(s => s !== skill);
                },
                addAvailableDay() {
                    if (this.selectedDay && !this.userProfile.availability.includes(this.selectedDay)) {
                        this.userProfile.availability.push(this.selectedDay);
                        this.selectedDay = null;
                    }
                },
                removeAvailableDay(day) {
                    this.userProfile.availability = this.userProfile.availability.filter(d => d !== day);
                },
                async submitProfile() {
                    try {
                        const user = firebase.auth().currentUser;
                        if (user) {
                            await db.collection("UserQuestionnaire").doc(user.uid).set(this.userProfile);
                            console.log("Profile successfully submitted.");
                        }
                    } catch (error) {
                        console.error("Error submitting profile:", error);
                    }
                },
                goToProfile() {
                    // Redirect or handle the profile button action
                }
            }
        }).mount("#app");
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>