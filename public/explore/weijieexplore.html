<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonprofit Listings</title>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="testing.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="../config.js"></script> <!-- Firebase config file -->
    <script src="https://maps.googleapis.com/maps/api/js?key="></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <!-- Navbar Brand -->
            <a class="navbar-brand" href="#">
                <img src="images/Volunteer.png" alt="logo" />
            </a>

            <!-- Toggler for mobile view -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navbar Links-->
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="active" href="#">Explore</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Calendar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Donate</a>
                    </li>
                </ul>
            </div>

            <!-- Sign In Button on the far right -->
            <div class="d-flex">
                <button id="signin" class="btn" type="button">My Profile</button>
            </div>
        </div>
    </nav>

    <div class="jumbotron">
        <div id="jumbotron-carousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="help6.jpg" class="d-block w-100" alt="Image 1">
                </div>
                <div class="carousel-item">
                    <img src="help5.jpg" class="d-block w-100" alt="Image 2">
                </div>
                <div class="carousel-item">
                    <img src="vol1.jpg" class="d-block w-100" alt="Image 3">
                </div>
                <div class="carousel-item">
                    <img src="help8.jpg" class="d-block w-100" alt="Image 4">
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#jumbotron-carousel"
                data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#jumbotron-carousel"
                data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
        <div class="jumbotron-content">
            <h1>EXPLORE</h1>
            <p>The opportunities designed to fit you</p>
            <a href="#" class="button">Create a Post</a>
        </div>
    </div>

    <div id="body">
        <div id="app">
            <!-- Top Matches Section -->
            <div class="container mt-0">
                <div class="topmatch-container">
                    <h3 class="header">Your Top Matches</h3>
                    <div class="scrollable-row-wrapper d-flex flex-nowrap overflow-auto">
                        <div class="card topmatch" v-for="(card, index) in topRecommendedCards" :key="index"
                            @click="openPreview(card)">
                            <img :src="card.imageUrl" class="card-img-top" alt="Card image">

                            <!-- Progress Bar for Match Score -->
                            <div v-if="showMatchBar" class="progress" style="height: 20px; margin-top: -4px;">
                                <div style="background-color: lightgreen;" class="progress-bar" role="progressbar"
                                    :style="{ width: card.matchScore + '%' }" :aria-valuenow="card.matchScore"
                                    aria-valuemin="0" aria-valuemax="100">
                                    {{ card.matchScore }}% Match
                                </div>
                            </div>

                            <div class="card-body">
                                <h5 class="card-title info-text">{{ card.title }}</h5>
                                <p class="card-text description-text">{{ card.description }}</p>
                                <p class="card-text info-text"><strong>Location:</strong> {{ card.location }}</p>
                                <p class="card-text  info-text"><strong>Skills:</strong> {{ Array.isArray(card.skills) ?
                                    card.skills.join(', ') : card.skills || "No skills listed" }}</p>
                                <p v-if="card.isRecurring" class="card-text"><strong>Weekly: </strong> {{
                                    Array.isArray(card.recurringDays) ? card.recurringDays.join(', ') :
                                    selectedCard.recurringDays || "No days listed" }}</p>
                                <p v-else class="card-text"><strong>Date: </strong>{{card.date}}</p>
                            </div>
                            <div class="card-footer text-center">
                                <a :href="card.mainurl" target="_blank" class="btn btn-primary">View Website</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>




            <!-- Add this right after your <div id="app"> -->
            <div class="topmatch-preview" v-if="showPreview" @click.self="closePreview">
                <div class="preview">
                    <div class="close-button" @click="closePreview">
                        <i class="fas fa-times"></i>
                    </div>

                    <div v-if="selectedCard" class="preview-content">
                        <div class="preview-header">
                            <img :src="selectedCard.imageUrl" class="preview-logo" alt="Organization logo">
                            <h5 class="card-title">{{ selectedCard.title }}</h5>
                        </div>

                        <div class="card-body">
                            <p class="card-text">{{ selectedCard.description }}</p>
                            <p class="card-text"><strong>Postal Code:</strong> {{ selectedCard.location }}</p>
                            <p class="card-text"><strong>Skills Needed:</strong> {{ Array.isArray(selectedCard.skills) ?
                                selectedCard.skills.join(', ') : selectedCard.skills || "No skills listed" }}</p>
                            <p v-if="selectedCard.isRecurring" class="card-text"><strong>Weekly Commitment:</strong> {{
                                Array.isArray(selectedCard.recurringDays) ? selectedCard.recurringDays.join(', ') :
                                selectedCard.recurringDays || "No days listed" }}</p>
                            <p v-if="selectedCard.isRecurring" class="card-text"><strong>Event Commitment Period:
                                </strong>{{selectedCard.recurringStartDate}} till {{ selectedCard.recurringEndDate}}</p>
                            <p v-else class="card-text"><strong>Date: </strong>{{selectedCard.date}}</p>
                            <p class="card-text"><strong>Time:</strong> {{ selectedCard.startTime }} - {{
                                selectedCard.endTime}}</p>
                        </div>
                        <div class="card-footer text-center">
                            <p class="card-text"><strong>Email: </strong>{{ selectedCard.email }}</p>
                            <a :href="selectedCard.mainurl" target="_blank" class="btn btn-primary">View Website</a>
                        </div>
                    </div>
                </div>
            </div>




            <div class="container my-4">
                <div class="text-center my-4">
                    <h2 class="header">General Listings</h2>
                </div>

                <div class="filters-container">
                    <!-- Skills Filter Section -->
                    <div class="skills-filter-section">
                        <div class="filter-header">
                            <h4>Filter by Skills</h4>
                            <button type="button" class="clear-filters-btn" v-if="hasSelectedFilters"
                                @click.stop="clearAllFilters">
                                Clear All
                            </button>
                        </div>
                        <div class="filter-chips">
                            <button type="button" v-for="skill in availableSkills" :key="skill"
                                @click.stop="toggleFilter(skill)"
                                :class="['filter-chip', {'active': selectedFilters.includes(skill)}]">
                                <span class="filter-text">{{ skill }}</span>
                                <span class="filter-icon" v-if="selectedFilters.includes(skill)">✓</span>
                            </button>
                        </div>
                    </div>

                    <!-- Categories Filter Section -->
                    <div class="skills-filter-section">
                        <div class="filter-header">
                            <h4>Filter by Categories</h4>
                        </div>
                        <div class="filter-chips">
                            <button type="button" v-for="category in availableCategories" :key="category"
                                @click.stop="toggleFilter(category)"
                                :class="['filter-chip', {'active': selectedFilters.includes(category)}]">
                                <span class="filter-text">{{ category }}</span>
                                <span class="filter-icon" v-if="selectedFilters.includes(category)">✓</span>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Filters Counter -->
                    <div class="selected-filters" v-if="hasSelectedFilters">
                        <p class="filter-count">
                            {{ selectedFilters.length }} filter{{ selectedFilters.length > 1 ? 's' : '' }} selected
                        </p>
                    </div>
                </div>

                <!-- Updated listings grid -->
                <div class="d-flex d-sm-block justify-content-center">
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                        <div v-for="listing in filteredListings" :key="listing.uid">
                            <div class="card m-2" style="width: 100%;" @click="openPreview(listing)">
                                <img :src="listing.imageUrl" class="card-img-top">
                                <div class="card-body">
                                    <h5 class="card-title">{{ listing.title }}</h5>
                                    <p class="card-text description-text">{{ listing.description }}</p>
                                    <p class="card-text info-text"><strong>Location:</strong> {{ listing.location }}</p>
                                    <p class="card-text info-text"><strong>Skills: </strong> {{
                                        Array.isArray(listing.skills) ? listing.skills.join(', ') : listing.skills ||
                                        "No skills listed" }}</p>
                                    <p v-if="listing.isRecurring" class="card-text"><strong>Weekly:</strong> {{
                                        Array.isArray(listing.recurringDays) ? listing.recurringDays.join(', ') :
                                        listing.recurringDays || "No days listed" }}</p>
                                    <p v-else class="card-text"><strong>Date: </strong>{{listing.date}}</p>
                                </div>
                                <div class="card-footer text-center">
                                    <a :href="listing.mainurl" target="_blank" class="btn btn-primary" @click.stop>
                                        View Website
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script>

            const app = Vue.createApp({
                data() {
                    return {
                        showMatchBar: false,
                        recommendedCards: [],
                        showPreview: false,
                        selectedCard: null,
                        selectedFilters: [], // Combined filters array
                        availableSkills: [],
                        availableCategories: [],
                    };
                },
                methods: {
                    clearAllFilters() {
                        this.selectedFilters = [];
                    },

                    toggleFilter(filter) {
                        const index = this.selectedFilters.indexOf(filter);
                        if (index > -1) {
                            this.selectedFilters.splice(index, 1);
                        } else {
                            this.selectedFilters.push(filter);
                        }
                    },

                    // Combined matching for both skills and categories
                    matchesFilters(listing) {
                        if (!this.selectedFilters.length) return true;

                        // Combine listing's skills and categories for matching
                        const listingTags = [
                            ...(Array.isArray(listing.skills) ? listing.skills : [listing.skills]),
                            ...(Array.isArray(listing.category) ? listing.category : [listing.category])
                        ]
                            .filter(tag => tag && tag !== 'None')
                            .map(tag => tag.toLowerCase());

                        // Check if ALL selected filters match at least one of the listing's tags
                        const selectedFiltersLower = this.selectedFilters.map(filter => filter.toLowerCase());
                        return selectedFiltersLower.every(filter => listingTags.includes(filter));
                    },


                    isValidListing(listing) {
                        return this.isValidDate(listing) && this.matchesFilters(listing);
                    },

                    isValidDate(listing) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (listing.isRecurring) {
                            if (!listing.recurringEndDate) return true;
                            const endDate = new Date(listing.recurringEndDate);
                            return endDate >= today;
                        } else {
                            if (!listing.date) return true;
                            const eventDate = new Date(listing.date);
                            return eventDate >= today;
                        }
                    },

                    async fetchListings() {
                        const db = firebase.firestore();
                        try {
                            const querySnapshot = await db.collection('listings').get();
                            const info = [];
                            const skillSet = new Set();
                            const categorySet = new Set();

                            querySnapshot.forEach((doc) => {
                                const data = doc.data();
                                const skills = Array.isArray(data.skills) ?
                                    data.skills.filter(skill => skill && skill !== 'None') :
                                    (data.skills ? [data.skills] : []);

                                const categories = Array.isArray(data.category) ?
                                    data.category.filter(cat => cat && cat !== 'None') :
                                    (data.category ? [data.category] : []);

                                // Collect all valid skills and categories
                                skills.forEach(skill => {
                                    if (skill && skill !== 'None') {
                                        skillSet.add(skill.trim());
                                    }
                                });

                                categories.forEach(category => {
                                    if (category && category !== 'None') {
                                        categorySet.add(category.trim());
                                    }
                                });

                                info.push({
                                    title: data.title || 'No title',
                                    description: data.description || 'No description',
                                    imageUrl: data.imageUrl || 'noimage.jpg',
                                    location: data.location || 'No location',
                                    skills: skills,
                                    category: categories,
                                    daysOfWeek: data.daysOfWeek || ['None'],
                                    mainurl: data.mainurl,
                                    email: data.email || ['None'],
                                    isRecurring: data.isRecurring,
                                    recurringDays: data.recurringDays,
                                    date: data.date,
                                    startTime: data.startTime,
                                    endTime: data.endTime,
                                    recurringStartDate: data.recurringStartDate,
                                    recurringEndDate: data.recurringEndDate,
                                });
                            });

                            this.recommendedCards = info;
                            this.availableSkills = Array.from(skillSet).sort();
                            this.availableCategories = Array.from(categorySet).sort();
                            this.fetchUserData();
                        } catch (error) {
                            console.error('Error fetching listings:', error);
                        }
                    },
                    // Fetch user data based on authentication state
                    async fetchUserData() {
                        const db = firebase.firestore();  // Access Firestore using the compat syntax

                        firebase.auth().onAuthStateChanged(async (user) => {
                            if (user) {
                                const uid = user.uid;  // Get the logged-in user's UID
                                console.log("User ID:", uid);

                                try {
                                    const querySnapshot = await db.collection('UserQuestionnaire')
                                        .where('uid', '==', uid).get();

                                    if (!querySnapshot.empty) {
                                        querySnapshot.forEach((doc) => {
                                            const data = doc.data();  // Get the document data
                                            console.log("User data found:", data);

                                            // Store the user's data in a local variable
                                            const userQuestionnaireData = {
                                                uid: data.uid,  // Store the user's UID
                                                interests: data.interests || [],  // Array of interests
                                                skills: data.skills || [],  // Array of skills
                                                location: data.location || 'No location',  // Location (e.g., postal code)
                                                availability: data.availability || []  // User's available days
                                            };

                                            // Show match bar and calculate the match score using listings and user data
                                            this.showMatchBar = true;
                                            this.calculateMatch(userQuestionnaireData);

                                        });
                                    } else {
                                        console.log("No document found in userQuestionnaire for UID:", uid);

                                    }

                                } catch (error) {
                                    console.error("Error fetching user data:", error);
                                }

                            } else {
                                console.log("No user is logged in.");
                                this.showMatchBar = false;  // Hide match bar if no user is logged in
                            }
                        });
                    },

                    // Calculate the match score for each listing
                    async calculateMatch(userData) {
                        if (userData && this.recommendedCards.length) {
                            this.showMatchBar = true;

                            /* Original code
                            // Loop through each listing and calculate match score
                            this.recommendedCards = this.recommendedCards.map((listing) => {
                              const matchScore = this.calculateMatchScore(userData, listing);
                              return {
                                ...listing,  // Spread operator to keep other listing data intact
                                matchScore  // Add/Update matchScore property
                              };
                            });
                            */
                            // Create an array of promises for calculating match scores
                            const matchScorePromises = this.recommendedCards.map(async (listing) => {
                                const matchScore = await this.calculateMatchScore(userData, listing);
                                return {
                                    ...listing,  // Spread operator to keep other listing data intact
                                    matchScore  // Add/Update matchScore property
                                };
                            });

                            // Wait for all match score calculations to complete
                            this.recommendedCards = await Promise.all(matchScorePromises);

                            // Sort listings based on matchScore descending once
                            this.recommendedCards.sort((a, b) => b.matchScore - a.matchScore);

                            console.log("Listings with match scores:", this.recommendedCards);

                        } else {
                            this.showMatchBar = false;
                        }
                    },

                    // Calculate the match score based on user and listing data
                    async calculateMatchScore(user, listing) {
                        // Weights for each criterion
                        const weights = {
                            interests: 0.3,
                            skills: 0.3,
                            location: 0.2,
                            availability: 0.2
                        };

                        // Interest match calculation
                        const interestMatch = user.interests.some(interest => listing.category.includes(interest)) ? 100 : 0;

                        // Skills match calculation
                        const matchedSkills = listing.skills.filter(skill => user.skills.includes(skill)).length;
                        const skillsMatch = (matchedSkills / listing.skills.length) * 100;

                        // Location match (for now assume 100%)
                        var locationMatch = 100;
                        // Brandyn Testing stuff
                        console.log("This is the listing location: ", listing.location)
                        console.log("This is the user's location: ", user.location)
                        const originLocation = encodeURIComponent(user.location);
                        const destinationLocation = encodeURIComponent(listing.location);
                        console.log("API Request URL:", `http://brandynchua.pythonanywhere.com/google_api/distancegetter?origins=${originLocation}&destinations=${destinationLocation}&units=metric`);
                        // if(listing.location !== "No location"){
                        //   const response = await axios.get("http://brandynchua.pythonanywhere.com/google_api/distancegetter", {
                        //     params: {
                        //       origins: user.location,
                        //       destinations: listing.location,
                        //       units: 'metric',
                        //     }
                        //   })
                        //   .then(response=> {
                        //     var temp_holding = response.data
                        //     var distance_value = temp_holding.rows[0].elements[0].distance.value
                        //     console.log("This is the distance_value: ", distance_value)
                        //     console.log("This is the type of distance_value: ", typeof(distance_value))
                        //     // Distance calculation
                        //     // If distance is more then 20km, set to 0. Else, 20km minus 
                        //     if(distance_value >= 20000){
                        //       locationMatch = 0
                        //     }
                        //     else{
                        //       locationMatch = (20000 - distance_value)/200
                        //     }
                        //   })
                        //   .catch(error=> {
                        //     console.error("No distance? : ", error)
                        //   })
                        // }

                        // Availability match calculation
                        // Log the value and type of listing.daysOfWeek for debugging
                        console.log("Listing daysOfWeek:", listing.daysOfWeek, "Type:", typeof listing.daysOfWeek);
                        const matchedDays = listing.daysOfWeek.filter(day => user.availability.includes(day)).length;
                        const availabilityMatch = (matchedDays / listing.daysOfWeek.length) * 100;

                        // Total match score calculation
                        const totalMatchScore = Math.round(
                            (weights.interests * interestMatch) +
                            (weights.skills * skillsMatch) +
                            (weights.location * locationMatch) +
                            (weights.availability * availabilityMatch)
                        );

                        return totalMatchScore;
                    },

                    openPreview(card) {
                        const currentFilters = [...this.selectedFilters];
                        this.selectedCard = card;
                        this.showPreview = true;
                        this.selectedFilters = currentFilters;
                        document.body.classList.add('modal-open');
                    },

                    closePreview() {
                        const currentFilters = [...this.selectedFilters];
                        this.showPreview = false;
                        this.selectedCard = null;
                        this.selectedFilters = currentFilters;
                        document.body.classList.remove('modal-open');
                    },
                },
                computed: {
                    // Helper computed property for selected filters visibility
                    hasSelectedFilters() {
                        return this.selectedFilters.length > 0;
                    },

                    // Get currently selected skills
                    selectedSkills() {
                        return this.selectedFilters.filter(filter =>
                            this.availableSkills.includes(filter)
                        );
                    },

                    // Get currently selected categories
                    selectedCategories() {
                        return this.selectedFilters.filter(filter =>
                            this.availableCategories.includes(filter)
                        );
                    },

                    validListings() {
                        return this.recommendedCards.filter(listing => this.isValidListing(listing));
                    },

                    topRecommendedCards() {
                        return this.recommendedCards
                            .filter(listing => this.isValidDate(listing))
                            .slice(0, 8);
                    },

                    filteredListings() {
                        const remainingListings = this.recommendedCards
                            .filter(listing => this.isValidDate(listing))
                            .slice(8);

                        if (!this.selectedFilters.length) {
                            return remainingListings;
                        }

                        return remainingListings.filter(listing => this.matchesFilters(listing));
                    }
                },
                created() {
                    this.fetchListings();
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.showPreview) {
                            this.closePreview();
                        }
                    });
                }
            });

            vm = app.mount('#app');
        </script>